name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  quality:
    name: Quality Checks
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    env:
      CI: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 1

      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          pnpm-version: "10"
          install-args: "--frozen-lockfile"

      - name: Run Biome linter
run: |
          echo "::group::Running Biome linter"
          pnpm run lint 2>&1 | tee lint-output.log
          EXIT_CODE="${PIPESTATUS[0]}"
          echo "::endgroup::"
          if [ "$EXIT_CODE" -ne 0 ]; then
            echo "::error::Linting failed with exit code $EXIT_CODE"
            echo "### Linting Failed" >> $GITHUB_STEP_SUMMARY
            echo "Exit code: $EXIT_CODE" >> $GITHUB_STEP_SUMMARY
            echo '
          echo "Linting passed successfully"

      - name: Run TypeScript type checking
        run: |
          echo "::group::Running TypeScript type checking"
          pnpm run typecheck 2>&1 | tee check-output.log
          EXIT_CODE=${PIPESTATUS[0]}
          echo "::endgroup::"
          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::Type checking failed with exit code $EXIT_CODE"
            echo "### Type Checking Failed" >> $GITHUB_STEP_SUMMARY
            echo "Exit code: $EXIT_CODE" >> $GITHUB_STEP_SUMMARY
            echo '```text' >> $GITHUB_STEP_SUMMARY
            tail -100 check-output.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit $EXIT_CODE
          fi
          echo "Type checking completed"

      - name: Run tests
        run: |
          echo "::group::Running tests"
          pnpm run test 2>&1 | tee test-output.log
          EXIT_CODE=${PIPESTATUS[0]}
          echo "::endgroup::"
          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::Tests failed with exit code $EXIT_CODE"
            echo "### Tests Failed" >> $GITHUB_STEP_SUMMARY
            echo "Exit code: $EXIT_CODE" >> $GITHUB_STEP_SUMMARY
            echo '```text' >> $GITHUB_STEP_SUMMARY
            tail -100 test-output.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit $EXIT_CODE
          fi
          echo "Tests passed successfully"

      - name: Build project
        run: |
          echo "::group::Building project"
          pnpm run build 2>&1 | tee build-output.log
          EXIT_CODE=${PIPESTATUS[0]}
          echo "::endgroup::"
          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::Build failed with exit code $EXIT_CODE"
            echo "### Build Failed" >> $GITHUB_STEP_SUMMARY
            echo "Exit code: $EXIT_CODE" >> $GITHUB_STEP_SUMMARY
            echo '```text' >> $GITHUB_STEP_SUMMARY
            tail -100 build-output.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit $EXIT_CODE
          fi
          echo "Build completed successfully"

      - name: Upload build artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: dist
          path: dist/
          retention-days: 1

  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [quality]
    if: always()
    permissions:
      contents: read
    steps:
      - name: Check all jobs
        run: |
          if [ "${{ needs.quality.result }}" != "success" ]; then
            echo "One or more checks failed"
            exit 1
          fi
          echo "All checks passed successfully!"
